<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>

    <link href="css/toolbar.css" rel="stylesheet" type="text/css" />
    <link href="css/editor.css" rel="stylesheet" type="text/css" />
    <link href="css/splitter.css" rel="stylesheet" type="text/css" />
    <link href="css/logger.css" rel="stylesheet" type="text/css" />
    <link href="css/modals.css" rel="stylesheet" type="text/css" />
    
    <script type="text/javascript">window.$ = window.jQuery = require('./jquery.min.js');</script>
    <script src="splitter.js" type="text/javascript" charset="utf-8"></script>

    <style type="text/css" media="screen">
        html, body {
            overflow: hidden;
            margin: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="hLayout">
        <div id="paneMain"></div>
        <div id="paneLog"></div>
    </div>

    <script>
        var Toolbar = require('./toolbar');
        var Editor = require('./editor');
        var Logger = require('./logger');
        var doc = require('./doc');
        var ipc = require('ipc');
        var fs = require('fs');
        var remote = require('remote');
        var dialog = remote.require('dialog');

        document.onkeydown = function(evt) {
            if (evt.keyCode == 8) {     // cancel backspace to prevent 'Back' action
                event.preventDefault();
            }
        };

        // toolbar
        var toolbar = new Toolbar();
        document.body.insertBefore(toolbar, document.body.firstChild);

        // layout
        $("#hLayout").splitter({ type: "h", anchorToWindow: true, sizeBottom: true });

        // editor
        var editor = new Editor(); 
        toolbar.btnSave.setClickHandler(editor.save);
        ipc.on('file-open', function () {
            var file = dialog.showOpenDialog(
                remote.getCurrentWindow(), 
                { 
                    properties: [ 'openFile', 'openFile' ],
                    filters: 
                    [
                        { name: 'JavaScript', extensions: ['js'] },
                        { name: 'All Files', extensions: ['*'] }
                    ]
                }
            );
            if (file) {
                editor.currentFilename = file[0];
                fs.readFile(file[0], 'utf8', function (err,data) {
                    if (err) {
                        return console.log(err);
                    }
                    editor.setContent(data);
                    toolbar.btnSave.disable();
                });
            }
        });
        ipc.on('file-save', function () {
            editor.save();
        });
        ipc.on('file-save-as', function () {
            editor.saveAs();
        });
        
        $('#paneMain').bind('splitresize', function(){
            editor.editor.resize(); 
        }); 
        var paneMain = document.getElementById('paneMain');
        paneMain.appendChild(editor);
 
        // apidoc div
        var apiDoc = this.el = document.createElement('div');
        apiDoc.setAttribute('id', 'apidoc');
        apiDoc.setAttribute('style', 'display:none;');
        document.body.appendChild(apiDoc);

        // docs
        var docs = doc.init();

        // logger
        var logger = new Logger();
        document.getElementById('paneLog').appendChild(logger);
    </script>

    <div class="modal" id="modal-settings" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-header">Runtime Settings</div>
        <div class="modal-body">
            <div class="hr first">General</div>
            <div style="float:left;padding-right: 10px;">Iterations:</div><input type="text" id="iterations" style="width: 60px;" />
            <div class="hr">Test Parameters</div>
            <span>Choose parameter file:</span>
            <input id="paramsFilePath" type="text" class="input-path" readonly />
            <input type="button" value="Browse..." onclick="selectParamsFile();" />
            <div style="margin-top:15px;">
                <span>Read next value:</span>
                <select id="paramNextValue">
                    <option value="random">Randomly</option>
                    <option value="sequential">Sequentialy</option>
                </select>
            </div>
            <div class="hr">Page Objects</div>
            <span>Choose configuration file:</span>
            <input id="configFilePath" type="text" class="input-path" readonly />
            <input type="button" value="Browse..."  onclick="selectConfigFile();" />
        </div>
        <div class="modal-footer">
            <a href="#" class="cancel" onclick="hideSettings();">Cancel</a> <a href="#" class="btn" onclick="runtimeSettingsSave();">Save</a>
        </div>
        </div>
      </div>
    </div>
    
    <script>
        runtimeSettings = {};
        
        function hideSettings() {
             document.getElementById('modal-settings').className = 
                document.getElementById('modal-settings').className.replace(/\bshow\b/,'');
        }
        
        function selectParamsFile() {
            var file = selectFile(
                [
                    { name: 'CSV', extensions: ['csv'] },
                    { name: 'All Files', extensions: ['*'] }
                ]
            );                   
            if (file) {
                document.getElementById('paramsFilePath').value = file;
            }
        }
        
        function selectConfigFile() {
            var file = selectFile(
                [
                    { name: 'Test Case Config', extensions: ['config'] },
                    { name: 'All Files', extensions: ['*'] }
                ]
            );                   
            if (file) {
                document.getElementById('configFilePath').value = file;
            }
        }
        
        function selectFile(filters) {
            return dialog.showOpenDialog(
                remote.getCurrentWindow(), 
                { 
                    properties: [ 'openFile', 'openFile' ],
                    filters: filters
                }
            );
        }
        
        function runtimeSettingsSave() {
            var paramsFilePath = document.getElementById('paramsFilePath').value;
            if (paramsFilePath !== '') {
                runtimeSettings.paramsFilePath = paramsFilePath;
            }
            
            var configFilePath = document.getElementById('configFilePath').value;
            if (configFilePath !== '') {
                runtimeSettings.configFilePath = configFilePath;
            }
            
            var iterations = document.getElementById('iterations').value;
            if (iterations !== '') {
                runtimeSettings.iterations = iterations;
            }
            
            var nv = document.getElementById("paramNextValue");
            runtimeSettings.paramNextValue = nv.options[nv.selectedIndex].value;
            
            hideSettings();
        }
    </script>
</body>
</html>